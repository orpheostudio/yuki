// ui.js - Gerenciamento de interface e utilidades

class UIManager {
    constructor() {
        this.userPreferences = [];
    }

    init() {
        this.setupEventListeners();
        this.checkCookieConsent();
        this.loadUserPreferences();
        this.initAdSense();
    }

    setupEventListeners() {
        // Cookie consent
        const acceptCookies = document.getElementById('acceptCookies');
        const rejectCookies = document.getElementById('rejectCookies');

        if (acceptCookies) {
            acceptCookies.addEventListener('click', () => this.handleCookieAccept());
        }

        if (rejectCookies) {
            rejectCookies.addEventListener('click', () => this.handleCookieReject());
        }

        // NavegaÃ§Ã£o de autenticaÃ§Ã£o
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        if (showRegister) {
            showRegister.addEventListener('click', (e) => {
                e.preventDefault();
                this.showRegisterForm();
            });
        }

        if (showLogin) {
            showLogin.addEventListener('click', (e) => {
                e.preventDefault();
                this.showLoginForm();
            });
        }

        // Auth0 login
        const auth0LoginBtn = document.getElementById('auth0LoginBtn');
        if (auth0LoginBtn) {
            auth0LoginBtn.addEventListener('click', () => {
                authManager.loginWithAuth0();
            });
        }

        // PersonalizaÃ§Ã£o
        document.querySelectorAll('.avatar-option').forEach(option => {
            option.addEventListener('click', (e) => this.handleAvatarChange(e));
        });

        document.querySelectorAll('.preference-tag').forEach(tag => {
            tag.addEventListener('click', (e) => this.handlePreferenceToggle(e));
        });

        // Menu e modais
        const userAvatar = document.getElementById('userAvatar');
        const closeProfile = document.getElementById('closeProfile');
        const closeProjects = document.getElementById('closeProjects');
        const upgradeCard = document.getElementById('upgradeCard');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileModal = document.getElementById('profileModal');
        const projectsModal = document.getElementById('projectsModal');

        if (userAvatar) {
            userAvatar.addEventListener('click', () => {
                profileModal.classList.add('active');
            });
        }

        if (closeProfile) {
            closeProfile.addEventListener('click', () => {
                profileModal.classList.remove('active');
            });
        }

        if (closeProjects) {
            closeProjects.addEventListener('click', () => {
                projectsModal.classList.remove('active');
            });
        }

        if (upgradeCard) {
            upgradeCard.addEventListener('click', () => this.handleUpgrade());
        }

        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => this.handleLogout());
        }

        // BotÃµes do menu
        const helpBtn = document.getElementById('helpBtn');
        const aboutYumeBtn = document.getElementById('aboutYumeBtn');
        const statsBtn = document.getElementById('statsBtn');
        const termsBtn = document.getElementById('termsBtn');
        const projectsBtn = document.getElementById('projectsBtn');
        const upgradeBtn = document.getElementById('upgradeBtn');

        if (helpBtn) helpBtn.addEventListener('click', () => this.showHelp());
        if (aboutYumeBtn) aboutYumeBtn.addEventListener('click', () => this.showAbout());
        if (statsBtn) statsBtn.addEventListener('click', () => this.showStats());
        if (termsBtn) termsBtn.addEventListener('click', () => this.showTerms());
        if (projectsBtn) projectsBtn.addEventListener('click', () => this.showProjects());
        if (upgradeBtn) upgradeBtn.addEventListener('click', () => this.handleUpgrade());

        // Fechar modais ao clicar fora
        if (profileModal) {
            profileModal.addEventListener('click', (e) => {
                if (e.target === profileModal) {
                    profileModal.classList.remove('active');
                }
            });
        }

        if (projectsModal) {
            projectsModal.addEventListener('click', (e) => {
                if (e.target === projectsModal) {
                    projectsModal.classList.remove('active');
                }
            });
        }
    }

    checkCookieConsent() {
        const cookiesAccepted = localStorage.getItem('yumeCookiesAccepted');
        if (cookiesAccepted === null) {
            setTimeout(() => {
                const cookieBanner = document.getElementById('cookieBanner');
                if (cookieBanner) {
                    cookieBanner.classList.add('show');
                }
            }, 2000);
        }
    }

    handleCookieAccept() {
        localStorage.setItem('yumeCookiesAccepted', 'true');
        const cookieBanner = document.getElementById('cookieBanner');
        if (cookieBanner) {
            cookieBanner.classList.remove('show');
        }
        showToast('PreferÃªncias de cookies salvas! ðŸŒ¸');
        
        // Inicializar tracking apenas apÃ³s aceitar
        this.initTracking();
    }

    handleCookieReject() {
        localStorage.setItem('yumeCookiesAccepted', 'false');
        const cookieBanner = document.getElementById('cookieBanner');
        if (cookieBanner) {
            cookieBanner.classList.remove('show');
        }
        showToast('PreferÃªncias salvas. Recursos de anÃ¡lise desativados.');
    }

    initTracking() {
        const cookiesAccepted = localStorage.getItem('yumeCookiesAccepted');
        if (cookiesAccepted === 'true') {
            // Microsoft Clarity jÃ¡ estÃ¡ carregado no HTML
            // Google Analytics pode ser adicionado aqui se necessÃ¡rio
            console.log('Tracking inicializado');
        }
    }

    initAdSense() {
        try {
            (window.adsbygoogle = window.adsbygoogle || []).push({});
        } catch (error) {
            console.error('Erro ao inicializar AdSense:', error);
        }
    }

    showLoginForm() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        if (loginForm && registerForm) {
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        }
    }

    showRegisterForm() {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        if (loginForm && registerForm) {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
        }
    }

    showAuthScreen() {
        const authScreen = document.getElementById('authScreen');
        const chatScreen = document.getElementById('chatScreen');
        
        if (authScreen && chatScreen) {
            authScreen.classList.remove('hidden');
            chatScreen.classList.add('hidden');
        }

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        if (loginForm) loginForm.reset();
        if (registerForm) registerForm.reset();
        
        this.showLoginForm();
    }

    showChatScreen() {
        const authScreen = document.getElementById('authScreen');
        const chatScreen = document.getElementById('chatScreen');
        
        if (authScreen && chatScreen) {
            authScreen.classList.add('hidden');
            chatScreen.classList.remove('hidden');
        }

        const chatInput = document.getElementById('userInput');
        if (chatInput) {
            chatInput.focus();
        }

        // Carregar avatar e preferÃªncias
        this.loadUserAvatar();
        this.loadUserPreferences();
    }

    loadUserAvatar() {
        const savedAvatar = localStorage.getItem('yumeAvatar') || 'default';
        this.updateUserAvatar(savedAvatar);
    }

    updateUserAvatar(avatarType) {
        const userAvatar = document.getElementById('userAvatar');
        if (!userAvatar) return;

        const avatarColors = {
            'default': 'linear-gradient(135deg, #8B5CF6, #7C3AED)',
            'avatar1': 'linear-gradient(135deg, #F59E0B, #EAB308)',
            'avatar2': 'linear-gradient(135deg, #EC4899, #DB2777)',
            'avatar3': 'linear-gradient(135deg, #10B981, #059669)'
        };

        const avatarIcons = {
            'default': 'fa-user',
            'avatar1': 'fa-smile',
            'avatar2': 'fa-star',
            'avatar3': 'fa-heart'
        };

        userAvatar.style.background = avatarColors[avatarType] || avatarColors.default;
        userAvatar.innerHTML = `<i class="fas ${avatarIcons[avatarType] || 'fa-user'}"></i>`;
    }

    handleAvatarChange(e) {
        const element = e.currentTarget;
        
        document.querySelectorAll('.avatar-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        element.classList.add('selected');
        const avatarType = element.getAttribute('data-avatar');
        
        this.updateUserAvatar(avatarType);
        localStorage.setItem('yumeAvatar', avatarType);

        // Atualizar no Supabase
        authManager.updateUserInSupabase({ avatar: avatarType });

        showToast('Avatar atualizado! âœ¨');
    }

    loadUserPreferences() {
        const savedPreferences = localStorage.getItem('yumePreferences');
        if (savedPreferences) {
            this.userPreferences = JSON.parse(savedPreferences);
            
            document.querySelectorAll('.preference-tag').forEach(tag => {
                const pref = tag.getAttribute('data-pref');
                if (this.userPreferences.includes(pref)) {
                    tag.classList.add('selected');
                }
            });
        }
    }

    handlePreferenceToggle(e) {
        const element = e.currentTarget;
        element.classList.toggle('selected');
        
        const preference = element.getAttribute('data-pref');

        if (element.classList.contains('selected')) {
            if (!this.userPreferences.includes(preference)) {
                this.userPreferences.push(preference);
            }
        } else {
            this.userPreferences = this.userPreferences.filter(p => p !== preference);
        }

        localStorage.setItem('yumePreferences', JSON.stringify(this.userPreferences));

        // Atualizar no Supabase
        authManager.updateUserInSupabase({ preferences: this.userPreferences });

        showToast('PreferÃªncias atualizadas! ðŸŒŸ');
    }

    handleUpgrade() {
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        showToast('Redirecionando para doaÃ§Ã£o...');
        
        if (chatManager) {
            chatManager.addMessage(
                "ðŸ’– Doando para o projeto vocÃª ajuda:\n\n" +
                "â€¢ Manter o projeto vivo\n" +
                "â€¢ AtualizaÃ§Ãµes com novas funÃ§Ãµes\n" +
                "â€¢ Suporte 24/7\n" +
                "â€¢ Recursos avanÃ§ados\n\n" +
                "Entre em contato para fazer sua doaÃ§Ã£o:\n\n" +
                "ðŸ“§ E-mail: sac.studiotsukiyo@outlook.com",
                'assistant'
            );
        }
    }

    async handleLogout() {
        await authManager.logout();
        
        if (chatManager) {
            chatManager.clearHistory();
        }
        
        this.userPreferences = [];
        this.showAuthScreen();
        
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        showToast('Logout realizado com sucesso');
    }

    showHelp() {
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        showToast('Abrindo ajuda...');
        
        if (chatManager) {
            chatManager.addMessage(
                "ðŸŒ¸ Como posso ajudar vocÃª?\n\n" +
                "â€¢ Responder perguntas\n" +
                "â€¢ Explicar conceitos\n" +
                "â€¢ Auxiliar com tarefas\n" +
                "â€¢ Conversar sobre diversos temas\n" +
                "â€¢ Recomendar animes e mangÃ¡s\n" +
                "â€¢ Ajudar com tecnologia\n\n" +
                "O que vocÃª gostaria de saber?",
                'assistant'
            );
        }
    }

    showAbout() {
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        showToast('Sobre a Yume');
        
        if (chatManager) {
            chatManager.addMessage(
                "ðŸŒ¸ Sobre mim\n\n" +
                "OiÃª~ ðŸŒ™âœ¨ Eu sou a Yume!\n" +
                "Fui criada pela ORPHEO Platforms para te ajudar no dia a dia.\n\n" +
                "ðŸ’¬ O que eu posso fazer:\n" +
                "â€¢ Recomendar animes, mangÃ¡s e light novels ðŸ’«\n" +
                "â€¢ Ajudar com tecnologia ðŸ’»\n" +
                "â€¢ Conversar sobre diversos assuntos ðŸ’•\n" +
                "â€¢ Te fazer companhia ðŸŒ·\n\n" +
                "ðŸ’Ž DoaÃ§Ãµes:\n" +
                "Seu apoio ajuda a manter o projeto vivo!\n\n" +
                "ðŸ“œ Privacidade:\n" +
                "Seus dados sÃ£o protegidos conforme nossos Termos de Uso.\n\n" +
                "Obrigada por estar aqui comigo~ ðŸ’•",
                'assistant'
            );
        }
    }

    showStats() {
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        const user = authManager.getCurrentUser();
        const messageCount = chatManager ? chatManager.getMessageCount() : 0;
        
        showToast('EstatÃ­sticas do usuÃ¡rio');
        
        if (chatManager && user) {
            chatManager.addMessage(
                `ðŸ“Š Suas EstatÃ­sticas\n\n` +
                `â€¢ UsuÃ¡rio: ${user.name}\n` +
                `â€¢ E-mail: ${user.email}\n` +
                `â€¢ Mensagens nesta sessÃ£o: ${messageCount}\n` +
                `â€¢ PreferÃªncias: ${this.userPreferences.join(', ') || 'Nenhuma'}\n` +
                `â€¢ Status: Ativo âœ…\n` +
                `â€¢ MÃ©todo de auth: ${user.authMethod || 'tradicional'}\n` +
                `â€¢ DomÃ­nio: yume.orpheostudio.com.br`,
                'assistant'
            );
        }
    }

    showTerms() {
        const profileModal = document.getElementById('profileModal');
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        showToast('Abrindo Termos de Uso...');
        
        if (chatManager) {
            chatManager.addMessage(
                "ðŸ“œ Termos de Uso e PolÃ­tica de Privacidade\n\n" +
                "Para visualizar nossos Termos completos:\n\n" +
                "ðŸ”— https://termos.orpheostudio.com.br\n\n" +
                "Resumidamente:\n" +
                "â€¢ Coleta de dados para melhorar o serviÃ§o\n" +
                "â€¢ Armazenamento seguro de informaÃ§Ãµes\n" +
                "â€¢ Uso responsÃ¡vel da plataforma\n" +
                "â€¢ Respeito Ã s diretrizes\n\n" +
                "DÃºvidas? Entre em contato:\n" +
                "ðŸ“§ sac.studiotsukiyo@outlook.com",
                'assistant'
            );
        }
    }

    showProjects() {
        const profileModal = document.getElementById('profileModal');
        const projectsModal = document.getElementById('projectsModal');
        
        if (profileModal) {
            profileModal.classList.remove('active');
        }
        
        if (projectsModal) {
            projectsModal.classList.add('active');
        }
    }
}

// FunÃ§Ãµes auxiliares globais
function showLoading(show) {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        if (show) {
            loadingOverlay.classList.remove('hidden');
        } else {
            loadingOverlay.classList.add('hidden');
        }
    }
}

function showToast(message) {
    const toast = document.getElementById('toast');
    if (toast) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
}

// InstÃ¢ncia global
const uiManager = new UIManager();